<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Squad Ops: High Score Edition</title>
    <style>
        body { margin: 0; overflow: hidden; background: #1a1a1a; font-family: sans-serif; touch-action: none; }
        canvas { display: block; background: #2d3e1d; }
        
        /* UI Screens */
        #menu, #end-screen { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); display: flex; flex-direction: column; 
            justify-content: center; align-items: center; color: white; z-index: 100;
        }
        
        .btn { 
            padding: 20px 60px; font-size: 24px; background: #2ecc71; color: white; 
            border: none; border-radius: 50px; cursor: pointer; font-weight: bold; 
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.4);
        }

        /* HUD Styling */
        #hud { position: absolute; top: 15px; left: 15px; color: white; pointer-events: none; display: none; z-index: 50; }
        #score-container { margin-top: 5px; font-size: 18px; color: #f1c40f; font-weight: bold; text-shadow: 1px 1px 2px black; }
        #high-score-hud { font-size: 12px; opacity: 0.7; color: white; font-weight: normal; }
        
        #minimap-container {
            position: absolute; top: 100px; left: 15px; width: 120px; height: 120px;
            background: rgba(0,0,0,0.7); border: 2px solid #3498db; border-radius: 10px; overflow: hidden; display: none; z-index: 50;
        }
        
        .bar { width: 180px; height: 14px; background: #333; border: 1.5px solid white; margin-top: 8px; border-radius: 7px; overflow: hidden; }
        #hp-fill { width: 100%; height: 100%; background: #2ecc71; transition: width 0.2s; }
        
        #combo-alert { color: #ff4757; font-style: italic; margin-left: 10px; transition: 0.1s; }
    </style>
</head>
<body>

<div id="menu">
    <h1 style="letter-spacing: 5px; font-size: 40px; margin-bottom: 10px;">SQUAD OPS</h1>
    <p style="margin-bottom: 30px; opacity: 0.7;">BATTLE ROYALE MOBILE</p>
    <button class="btn" onclick="startGame()">DEPLOY DUO</button>
</div>

<div id="end-screen" style="display: none;">
    <h1 id="end-title">VICTORY</h1>
    <h2 id="final-score" style="color: #f1c40f; margin: 5px 0;">SCORE: 0</h2>
    <h3 id="high-score-end" style="opacity: 0.6; font-weight: normal; margin-bottom: 25px;">BEST: 0</h3>
    <button class="btn" onclick="location.reload()">REDEPLOY</button>
</div>

<div id="hud">
    <div style="font-weight: bold; font-size: 16px;">SQUAD: <span id="sCount">0</span> | ENEMIES: <span id="eCount">0</span></div>
    <div id="score-container">
        SCORE: <span id="currentScore">0</span>
        <span id="combo-alert"></span>
        <div id="high-score-hud"></div>
    </div>
    <div class="bar"><div id="hp-fill"></div></div>
</div>

<div id="minimap-container"><canvas id="mmCanvas" width="120" height="120"></canvas></div>
<canvas id="gameCanvas"></canvas>

<script>
// --- GAME & SCORING VARIABLES ---
let score = 0, killsCount = 0, bossKills = 0;
let combo = 1, comboTimer = 0;
const COMBO_TIME_LIMIT = 300; // ~5 seconds at 60fps

// --- AUDIO SYSTEM ---
let audioCtx = null;
function initAudio() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === 'suspended') audioCtx.resume();
}

function playSound(freq, type = 'square', decay = 0.1) {
    if (!audioCtx) return;
    const now = audioCtx.currentTime;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, now);
    osc.frequency.exponentialRampToValueAtTime(10, now + decay);
    gain.gain.setValueAtTime(0.1, now);
    gain.gain.exponentialRampToValueAtTime(0.01, now + decay);
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start();
    osc.stop(now + decay);
}

// --- CORE ENGINE ---
const canvas = document.getElementById('gameCanvas'), ctx = canvas.getContext('2d');
const mmCanvas = document.getElementById('mmCanvas'), mmCtx = mmCanvas.getContext('2d');
const hpFill = document.getElementById('hp-fill'), sCountTxt = document.getElementById('sCount'), eCountTxt = document.getElementById('eCount');
const scoreTxt = document.getElementById('currentScore');
const comboTxt = document.getElementById('combo-alert');

let w, h, player, gameActive = false, bossSpawned = false;
let entities = [], bullets = [], environment = [];
let worldSize = 4000, camera = { x: 0, y: 0 };
let zone = { x: 2000, y: 2000, r: 2200, targetR: 200 };
let joy = { active: false, startX: 0, startY: 0, currX: 0, currY: 0, id: null };
let shoot = { active: false, startX: 0, startY: 0, currX: 0, currY: 0, id: null, cooldown: 0 };

// --- SCORE PERSISTENCE ---
function getHighScore() {
    return localStorage.getItem('squadOpsHighScore') || 0;
}

function saveHighScore(finalScore) {
    if (finalScore > getHighScore()) {
        localStorage.setItem('squadOpsHighScore', Math.floor(finalScore));
    }
}

function updateScoreUI() {
    scoreTxt.innerText = Math.floor(score);
    if(combo > 1) {
        comboTxt.innerText = "x" + combo + " COMBO!";
        comboTxt.style.opacity = comboTimer / COMBO_TIME_LIMIT;
    } else {
        comboTxt.innerText = "";
    }
}

function startGame() {
    initAudio();
    score = 0; combo = 1; comboTimer = 0; killsCount = 0; bossKills = 0;
    document.getElementById('menu').style.display = 'none';
    document.getElementById('hud').style.display = 'block';
    document.getElementById('minimap-container').style.display = 'block';
    document.getElementById('high-score-hud').innerText = "BEST: " + getHighScore();
    
    w = canvas.width = window.innerWidth;
    h = canvas.height = window.innerHeight;
    init();
    gameActive = true;
}

function init() {
    environment = []; entities = []; bullets = []; bossSpawned = false; zone.r = 2200;
    for(let i=0; i<120; i++) {
        let type = Math.random() > 0.4 ? (Math.random() > 0.5 ? 'tree' : 'bush') : 'rock';
        environment.push({ x: Math.random()*worldSize, y: Math.random()*worldSize, r: type === 'rock' ? 25 : 35, type });
    }
    for(let i=0; i<15; i++) environment.push({x: Math.random()*worldSize, y: Math.random()*worldSize, r: 15, type:'medkit', active: true});
    
    player = { id: 'player', x: 2000, y: 2000, team: 'blue', hp: 100, maxHp: 100, speed: 5, aimA: 0, weaponType: 'standard', pwrTimer: 0 };
    entities.push(player);
    spawnBot('blue', 2000, 2000, {dx:-60, dy:60});
    for(let i=0; i<25; i++) spawnBot('red', Math.random()*worldSize, Math.random()*worldSize);
}

function spawnBot(team, x, y, offset = null) {
    entities.push({ team, x, y, hp: 100, maxHp: 100, speed: 3.2, offset, inBush: false });
}

function checkCollision(obj, dx, dy) {
    let nx = obj.x + dx, ny = obj.y + dy;
    for(let env of environment) {
        if(env.type !== 'bush' && env.type !== 'medkit' && env.type !== 'weapon_drop') {
            let dist = Math.hypot(nx - env.x, ny - env.y);
            if(dist < env.r + 5) return true;
        }
    }
    return nx < 50 || nx > worldSize-50 || ny < 50 || ny > worldSize-50;
}

// --- TOUCH CONTROLS ---
canvas.addEventListener('touchstart', e => {
    if(!gameActive) return;
    for(let t of e.changedTouches) {
        if(t.clientX < w/2) { joy.active=true; joy.startX=joy.currX=t.clientX; joy.startY=joy.currY=t.clientY; joy.id=t.identifier; }
        else { shoot.active=true; shoot.startX=shoot.currX=t.clientX; shoot.startY=shoot.currY=t.clientY; shoot.id=t.identifier; }
    }
});
canvas.addEventListener('touchmove', e => {
    if(!gameActive) return; e.preventDefault();
    for(let t of e.changedTouches) {
        if(t.identifier === joy.id) { joy.currX=t.clientX; joy.currY=t.clientY; }
        if(t.identifier === shoot.id) { shoot.currX=t.clientX; shoot.currY=t.clientY; }
    }
}, {passive: false});
canvas.addEventListener('touchend', e => {
    for(let t of e.changedTouches) {
        if(t.identifier === joy.id) joy.active=false;
        if(t.identifier === shoot.id) shoot.active=false;
    }
});

// --- GAME LOOP UPDATE ---
function update() {
    if(!gameActive) return;
    if(zone.r > zone.targetR) zone.r -= 0.15;

    // Scoring & Combo logic
    score += 0.05; // Passive survival score
    if(comboTimer > 0) comboTimer--; else combo = 1;
    updateScoreUI();

    if(joy.active) {
        let a = Math.atan2(joy.currY-joy.startY, joy.currX-joy.startX);
        let mx = Math.cos(a)*player.speed, my = Math.sin(a)*player.speed;
        if(!checkCollision(player, mx, 0)) player.x += mx;
        if(!checkCollision(player, 0, my)) player.y += my;
    }

    let enemies = entities.filter(e => e.team === 'red');
    if(enemies.length < 5 && !bossSpawned) {
        bossSpawned = true;
        entities.push({ team: 'red', type: 'boss', x: player.x+300, y: player.y+300, hp: 700, maxHp: 700, speed: 2, dropSpawned: false });
    }

    if(shoot.active) player.aimA = Math.atan2(shoot.currY-shoot.startY, shoot.currX-shoot.startX);
    else {
        let target = enemies.find(en => Math.hypot(en.x-player.x, en.y-player.y) < 450);
        if(target) player.aimA = Math.atan2(target.y-player.y, target.x-player.x);
    }

    if((shoot.active || enemies.some(en => Math.hypot(en.x-player.x, en.y-player.y) < 400)) && shoot.cooldown <= 0) {
        let isHMG = player.weaponType === 'HMG' && player.pwrTimer > 0;
        bullets.push({x: player.x, y: player.y, vx: Math.cos(player.aimA)*15, vy: Math.sin(player.aimA)*15, team: 'blue', color: isHMG?'#9b59b6':'yellow'});
        playSound(isHMG ? 400 : 200, 'sawtooth', 0.1);
        shoot.cooldown = isHMG ? 5 : 12;
        if(isHMG) player.pwrTimer--;
    }
    shoot.cooldown--;

    entities.forEach((en, i) => {
        if(Math.hypot(en.x - zone.x, en.y - zone.y) > zone.r) en.hp -= 0.1;
        if(en.id !== 'player') {
            let target = entities.find(e => e.team !== en.team && Math.hypot(en.x-e.x, en.y-e.y) < 500);
            if(target) {
                let a = Math.atan2(target.y-en.y, target.x-en.x);
                if(!checkCollision(en, Math.cos(a)*en.speed, Math.sin(a)*en.speed)) {
                    en.x += Math.cos(a)*en.speed; en.y += Math.sin(a)*en.speed;
                }
                if(Math.random() < 0.02) bullets.push({x: en.x, y: en.y, vx: Math.cos(a)*10, vy: Math.sin(a)*10, team: en.team});
            } else if(en.team === 'blue') {
                let tx = player.x + en.offset.dx, ty = player.y + en.offset.dy;
                if(Math.hypot(tx-en.x, ty-en.y) > 30) {
                    let a = Math.atan2(ty-en.y, tx-en.x);
                    en.x += Math.cos(a)*player.speed*0.9; en.y += Math.sin(a)*player.speed*0.9;
                }
            }
            if(en.type === 'boss' && en.hp < 350 && !en.dropSpawned) {
                en.dropSpawned = true;
                environment.push({x: en.x, y: en.y, type:'weapon_drop', r:20, active: true});
            }
        }
        if(en.hp <= 0) {
            if(en.team === 'red') {
                combo++;
                comboTimer = COMBO_TIME_LIMIT;
                if(en.type === 'boss') { 
                    score += (250 * combo); 
                    endGame(true); 
                } else { 
                    score += (50 * combo); 
                    killsCount++;
                }
            }
            if(en.id === 'player') endGame(false);
            entities.splice(i, 1);
            playSound(100, 'sine', 0.2);
        }
    });

    environment.forEach(ev => {
        if(ev.active && Math.hypot(player.x-ev.x, player.y-ev.y) < 40) {
            if(ev.type === 'medkit') { player.hp = Math.min(100, player.hp + 30); ev.active = false; }
            if(ev.type === 'weapon_drop') { player.weaponType = 'HMG'; player.pwrTimer = 150; ev.active = false; }
            playSound(600, 'sine', 0.1);
        }
    });

    for(let i=bullets.length-1; i>=0; i--) {
        let b = bullets[i]; b.x += b.vx; b.y += b.vy;
        let hit = false;
        entities.forEach(en => { if(b.team !== en.team && Math.hypot(b.x-en.x, b.y-en.y) < 30) { en.hp -= 15; hit = true; } });
        if(hit || Math.hypot(b.x-player.x, b.y-player.y) > 1200) bullets.splice(i, 1);
    }

    camera.x = player.x - w/2; camera.y = player.y - h/2;
    hpFill.style.width = Math.max(0, player.hp) + "%";
    sCountTxt.innerText = entities.filter(e => e.team === 'blue').length;
    eCountTxt.innerText = entities.filter(e => e.team === 'red').length;
}

// --- RENDERING ---
function draw() {
    ctx.clearRect(0,0,w,h); if(!gameActive) return;
    ctx.save(); ctx.translate(-camera.x, -camera.y);
    ctx.strokeStyle = "rgba(52, 152, 219, 0.3)"; ctx.lineWidth = 10;
    ctx.beginPath(); ctx.arc(zone.x, zone.y, zone.r, 0, Math.PI*2); ctx.stroke();
    environment.forEach(env => {
        if(!env.active && (env.type === 'medkit' || env.type === 'weapon_drop')) return;
        ctx.beginPath();
        if(env.type === 'tree') ctx.fillStyle = "#1e8449";
        else if(env.type === 'bush') ctx.fillStyle = "rgba(34,139,34,0.4)";
        else if(env.type === 'rock') ctx.fillStyle = "#7f8c8d";
        else if(env.type === 'medkit') ctx.fillStyle = "white";
        else if(env.type === 'weapon_drop') ctx.fillStyle = "#9b59b6";
        if(env.type === 'medkit' || env.type === 'weapon_drop') ctx.fillRect(env.x-15, env.y-15, 30, 30);
        else { ctx.arc(env.x, env.y, env.r, 0, Math.PI*2); ctx.fill(); }
    });
    entities.forEach(en => {
        ctx.fillStyle = en.team === 'blue' ? '#3498db' : '#e74c3c';
        let s = en.type === 'boss' ? 40 : 18;
        ctx.beginPath(); ctx.arc(en.x, en.y, s, 0, Math.PI*2); ctx.fill();
        if(en.type === 'boss') {
            ctx.fillStyle = "red"; ctx.fillRect(en.x-40, en.y-60, 80, 8);
            ctx.fillStyle = "lime"; ctx.fillRect(en.x-40, en.y-60, 80*(en.hp/en.maxHp), 8);
        }
    });
    bullets.forEach(b => { ctx.fillStyle = b.color || "yellow"; ctx.beginPath(); ctx.arc(b.x, b.y, 4, 0, Math.PI*2); ctx.fill(); });
    ctx.restore();
    if(joy.active) drawStick(joy.startX, joy.startY, joy.currX, joy.currY, '#3498db');
    if(shoot.active) drawStick(shoot.startX, shoot.startY, shoot.currX, shoot.currY, '#e74c3c');
    drawMinimap();
}

function drawStick(sx, sy, cx, cy, col) {
    ctx.strokeStyle = col+"44"; ctx.lineWidth=4; ctx.beginPath(); ctx.arc(sx, sy, 50, 0, Math.PI*2); ctx.stroke();
    let a = Math.atan2(cy-sy, cx-sx), d = Math.min(50, Math.hypot(cx-sx, cy-sy));
    ctx.fillStyle = col+"88"; ctx.beginPath(); ctx.arc(sx+Math.cos(a)*d, sy+Math.sin(a)*d, 25, 0, Math.PI*2); ctx.fill();
}

function drawMinimap() {
    mmCtx.fillStyle = "black"; mmCtx.fillRect(0,0,120,120);
    let s = 120/worldSize;
    entities.forEach(en => {
        mmCtx.fillStyle = en.team === 'blue' ? '#3498db' : '#e74c3c';
        mmCtx.beginPath(); mmCtx.arc(en.x*s, en.y*s, 2, 0, Math.PI*2); mmCtx.fill();
    });
}

function endGame(win) {
    gameActive = false;
    if(win) score += 500;
    saveHighScore(score);
    
    document.getElementById('end-screen').style.display = 'flex';
    document.getElementById('end-title').innerText = win ? "VICTORY!" : "ELIMINATED";
    document.getElementById('end-title').style.color = win ? "#2ecc71" : "#e74c3c";
    document.getElementById('final-score').innerText = "SCORE: " + Math.floor(score);
    document.getElementById('high-score-end').innerText = "BEST: " + getHighScore();
}

function loop() { update(); draw(); requestAnimationFrame(loop); }
loop();
</script>
</body>
</html>
